/*
In order to delete a survey, several elements from the survey hierarcy need to
be deleted in order. These are (in order):
  0. TAXON_DETERMINATION
  1. TAXON_OCCURRENCE_DATA
  2. SAMPLE_DATA
  3. TAXON_OCCURRENCE
  4. SAMPLE_RECORDER
  5. SURVEY_EVENT_RECORDER
  6. SAMPLE
  7. SURVEY_EVENT
Each table row related to the survey has its ENTERED_BY field updated to
SXBRC_DELETE. Once this is done, rows with an SXBRC_DELETE flag will be deleted
*/

USE NBNData

DECLARE @survey_key VARCHAR(16);
DECLARE @del VARCHAR(12);
DECLARE @TEST VARCHAR(50);

-- Enter the survey_key of the survey you would like to delete here
SET @survey_key = 'THU00002000000D5';
SET @del = 'SXBRC_DELETE';

-- Update TAXON_DETERMINATION
PRINT '============================'
PRINT 'UPDATING TAXON_DETERMINATION'
UPDATE      TAXON_DETERMINATION
SET         ENTERED_BY = @del
FROM        TAXON_DETERMINATION TXD
INNER JOIN  TAXON_OCCURRENCE TXO ON
            TXD.TAXON_OCCURRENCE_KEY = TXO.TAXON_OCCURRENCE_KEY
INNER JOIN  SAMPLE SA ON
            TXO.SAMPLE_KEY = SA.SAMPLE_KEY
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update TAXON_OCCURRENCE_DATA
PRINT '=============================='
PRINT 'UPDATING TAXON_OCCURRENCE_DATA'
--SELECT S.ITEM_NAME, TXOD.ENTERED_BY
UPDATE      TAXON_OCCURRENCE_DATA
SET         ENTERED_BY = @del
FROM        TAXON_OCCURRENCE_DATA TXOD
INNER JOIN  TAXON_OCCURRENCE TXO ON
            TXOD.TAXON_OCCURRENCE_KEY = TXO.TAXON_OCCURRENCE_KEY
INNER JOIN  SAMPLE SA ON
            TXO.SAMPLE_KEY = SA.SAMPLE_KEY
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update SAMPLE_DATA
PRINT '===================='
PRINT 'UPDATING SAMPLE_DATA'
--SELECT      SAD.ENTERED_BY
UPDATE      SAMPLE_DATA
SET         ENTERED_BY = @del
FROM        SAMPLE_DATA SAD
INNER JOIN  SAMPLE SA ON
            SAD.SAMPLE_KEY = SA.SAMPLE_KEY
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update TAXON_OCCURRENCE
PRINT '========================='
PRINT 'UPDATING TAXON_OCCURRENCE'
--SELECT      TXO.ENTERED_BY
UPDATE      TAXON_OCCURRENCE
SET         ENTERED_BY = @del
FROM        TAXON_OCCURRENCE TXO
INNER JOIN  SAMPLE SA ON
            TXO.SAMPLE_KEY = SA.SAMPLE_KEY
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update SAMPLE_RECORDER
PRINT '========================'
PRINT 'UPDATING SAMPLE_RECORDER'
--SELECT      SAR.ENTERED_BY
UPDATE      SAMPLE_RECORDER
SET         ENTERED_BY = @del
FROM        SAMPLE_RECORDER SAR
INNER JOIN  SAMPLE SA ON
            SAR.SAMPLE_KEY = SA.SAMPLE_KEY
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update SURVEY_EVENT_RECORDER
PRINT '=============================='
PRINT 'UPDATING SURVEY_EVENT_RECORDER'
--SELECT      SER.ENTERED_BY
UPDATE      SURVEY_EVENT_RECORDER
SET         ENTERED_BY = @del
FROM        SURVEY_EVENT_RECORDER SER
INNER JOIN  SURVEY_EVENT SE ON
            SER.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update SAMPLE
PRINT '==============='
PRINT 'UPDATING SAMPLE'
--SELECT      SA.ENTERED_BY
UPDATE      SAMPLE
SET         ENTERED_BY = @del
FROM        SAMPLE SA
INNER JOIN  SURVEY_EVENT SE ON
            SA.SURVEY_EVENT_KEY = SE.SURVEY_EVENT_KEY
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;

-- Update SURVEY_EVENT
PRINT '====================='
PRINT 'UPDATING SURVEY_EVENT'
--SELECT      SE.ENTERED_BY
UPDATE      SURVEY_EVENT
SET         ENTERED_BY = @del
FROM        SURVEY_EVENT SE
INNER JOIN  SURVEY S ON
            SE.SURVEY_KEY = S.SURVEY_KEY
WHERE       S.SURVEY_KEY = @survey_key;
